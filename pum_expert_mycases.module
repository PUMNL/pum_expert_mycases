<?php

require_once 'config.inc';
require_once 'businessconfig.inc';
require_once 'menu.inc';

function pum_expert_mycases_views_api() {
    return array('api' => 3.0);
}

function pum_expert_mycases_preprocess_html(&$vars) {
  if (in_array('page-expert-my-main-activity-history', $vars['classes_array'])
    || in_array('page-expert-see-proposal', $vars['classes_array'])
    || in_array('page-expert-business-programme-proposal', $vars['classes_array'])
  ) {
    $vars['classes_array'][] = 'section-portal';
  }
}

function pum_expert_check_case_for_intake($case_type_id) {
  $config = pum_expert_mycases_config::singleton();
  $sep = CRM_Core_DAO::VALUE_SEPARATOR;
  $case_type = trim(str_replace($sep, ',', $case_type_id), ',');
  $case_types = explode(",", $case_type);
  if (in_array($config->getProjectInatkeCaseTypeId(), $case_types)) {
    return true;
  }
  return false;
}

/**
 * Implements hook_theme_registry_alter().
 */
function pum_expert_mycases_theme_registry_alter(&$theme_registry) {
    // Defined path to the current module.
    $module_path = drupal_get_path('module', 'pum_expert_mycases');
    // Find all .tpl.php files in this module's folder recursively.
    $template_file_objects = drupal_find_theme_templates($theme_registry, '.tpl.php', $module_path);
    // Iterate through all found template file objects.
    foreach ($template_file_objects as $key => $template_file_object) {
        // If the template has not already been overridden by a theme.
        if (!isset($theme_registry[$key]['theme path']) || !preg_match('#/themes/#', $theme_registry[$key]['theme path'])) {
            // Alter the theme path and template elements.
            $theme_registry[$key]['theme path'] = $module_path;
            $theme_registry[$key] = array_merge($theme_registry[$key], $template_file_object);
            $theme_registry[$key]['type'] = 'module';
        }
    }
}

function pum_expert_mycases_views_default_views() {
  $files = file_scan_directory(drupal_get_path('module', 'pum_expert_mycases'). '/views', '/.inc/');
  $views = array();
  civicrm_initialize();
  foreach ($files as $filepath => $file) {
    require $filepath;
    if (isset($view)) {
      $views[$view->name] = $view;
    }
  }
  return $views;
}

function pum_expert_mycases_get_role_ids($roles) {
    $rids = array();
    $available_roles = user_roles();
    foreach($roles as $role) {
        $rid = array_search($role, $available_roles);
        if ($rid !== false) {
            $rids[$rid] = $rid;
        }
    }

    return $rids;
}

function pum_expert_mycases_menu() {
    return _pum_expert_mycases_menu();
}

function _pum_expert_has_user_role_on_case($case_id) {
  static $roles = array();
  $case_id = trim($case_id);
  if (isset($roles[$case_id])) {
    return $roles[$case_id];
  }

  $roles[$case_id] = false;
  $session = CRM_Core_Session::singleton();
  $case = civicrm_api3('Case', 'getsingle', array('case_id' => $case_id));
  foreach($case['contacts'] as $contact) {
    if ($contact['contact_id'] == $session->get('userID')) {
      $roles[$case_id] = true;
      break;
    }
  }

  return $roles[$case_id];
}

function _pum_expert_show_activity_details($activity_id, $activity_type) {
  $config = pum_expert_mycases_config::singleton();
  $noDetailsActivityTypes = $config->getNoActivityDetailsList();
  if (!isset($noDetailsActivityTypes[$activity_type])) {
    return 'expert/my-cases/activitiy-detail/'.$activity_id;
  } else {
    return '';
  }
}

function _pum_expert_link_to_case_details($case_id, $case_type) {
    $config = pum_expert_mycases_config::singleton();
    $sep = CRM_Core_DAO::VALUE_SEPARATOR;
    $case_type = trim(str_replace($sep, ',', $case_type), ',');
    $case_types = explode(",", $case_type);
    if (in_array($config->getProjectInatkeCaseTypeId(), $case_types)) {
        return 'expert/my-cases/projectintake/'.$case_id;
    } else {
        return 'expert/my-cases/activities/'.$case_id;
    }
}

function pum_expert_mycases_get_mainactivity_follow_up($case_id) {
  $ma = civicrm_api3('MainActivity', 'DebriefingCC', array('case_id' => $case_id));
  return $ma['follow_up'];
}

function pum_expert_mycases_get_mainactivity_summary($case_id) {
  $ma = civicrm_api3('MainActivity', 'DebriefingCC', array('case_id' => $case_id));
  return $ma['summary'];
}